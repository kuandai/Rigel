# Persistence Backends

This document describes the two persistence backends currently implemented:
Cosmic Reach (CR) and Memory. It focuses on storage layout, mapping, and
format-specific behavior.

---

## 1. CR Backend

### 1.1 Format Descriptor

- Format ID: `cr`
- Version: `4`
- Extensions: `cosmicreach`, `crbin`, `json`
- Compression: LZ4 (optional, controlled by provider)
- Partial chunk saves: `false`
- Random access: `false`
- Entity regions: `true`
- Metadata format: `json`

### 1.2 Path Layout

Paths are generated by `CRPaths` and normalized by replacing `:` with `/` in
zone IDs:

- `worldInfo.json`
- `zones/<zoneId>/zoneInfo.json`
- `zones/<zoneId>/regions/region_<x>_<y>_<z>.cosmicreach`
- `zones/<zoneId>/entities/entityRegion_<x>_<y>_<z>.crbin`
- `players/localPlayer.json` (reserved; not currently written)

### 1.3 Region Layout and Chunk Mapping

Rigel chunks are 32x32x32. CR chunks are 16x16x16, so each Rigel chunk maps to
8 CR subchunks (2x2x2).

`CRRegionLayout`:

- Region span: 8 Rigel chunks per axis (equivalent to 16 CR chunks per axis).
- `storageKeysForChunk` returns 8 CR chunk keys.
- `spanForStorageKey` returns a 16^3 span with offsets derived from the
  subchunk index.

The mapping uses:

- `toCRChunk`: Rigel chunk + subchunk index -> CR chunk coords.
- `toRigelChunk`: CR chunk coords -> Rigel chunk + subchunk index.

### 1.4 Region File Format

Region files (`.cosmicreach`) contain:

- Magic (`0xFFECCEAC`) and version header.
- Compression type (`none` or `lz4`).
- Column offset table for 16x16 XZ columns.
- Column payloads containing stacked chunk data by Y.

Column payloads contain encoded chunk records written by `CRChunkCodec`.

LZ4 compression is optional and controlled by the provider
`rigel:persistence.cr` (`CRPersistenceSettings.enableLz4`).

### 1.5 Chunk Encoding

`CRChunkCodec` encodes a single 16x16x16 subchunk:

- Uses a palette of external block identifiers from a
  `BlockIdentityProvider` (`rigel:persistence.block_registry`).
- Encodes block layers using compact representations (byte/short/nibble/bit).
- Skylight and blocklight data are read but currently written as null.
- Block entity data is skipped (flagged as null).

Unknown identifier behavior is policy-driven via `PersistenceContext.policies`:

- `Fail`: throw on decode/encode unknown ID mappings.
- `Placeholder`: map to provider placeholder block.
- `Skip`: map unknowns to air.

If the block identity provider is missing, CR backend logs warnings and can
only safely process all-air chunk payloads.

### 1.6 Entity Regions

Entity regions are stored as `.crbin` files:

- Payload is written by `Entity::encodeEntityRegionPayload`.
- Payload is read by `Entity::decodeEntityRegionPayload`.
- CRBin is a schema-based binary format (see `CRBin`).

---

## 2. Memory Backend

### 2.1 Format Descriptor

- Format ID: `memory`
- Version: `1`
- Extensions: `mem`
- Compression: none
- Partial chunk saves: `true`
- Random access: `false`
- Entity regions: `true`
- Metadata format: `binary`

### 2.2 Path Layout

Paths are generated under the persistence root:

- `world.meta` (world metadata)
- `zones/<zoneId>/zone.meta` (zone metadata)
- `zones/<zoneId>/regions/region_<x>_<y>_<z>.mem`
- `zones/<zoneId>/entities/entityRegion_<x>_<y>_<z>.mem`
- `zones/<zoneId>/chunks/chunk_<x>_<y>_<z>.mem` (chunk-level IO)

### 2.3 Region Layout

`MemoryRegionLayout`:

- Region span: 16 chunks per axis.
- `storageKeysForChunk` returns a single chunk key.
- `spanForStorageKey` returns a full 32^3 span.

### 2.4 Encodings

The memory backend uses a straightforward binary encoding:

- Region files start with a chunk count, then serialized chunks.
- Chunk payloads include key, span, block count, and block states.
- Entity region files store chunk coordinates followed by entity records.

### 2.5 Storage Backend Usage

Despite the name, the memory backend still uses `StorageBackend`. With
`FilesystemBackend`, it writes `.mem` files to disk; with a custom backend it
can be entirely in-memory. This backend is primarily intended for tests and
simple debugging.

---

## Related Docs

- `docs/PersistenceAPI.md`
- `docs/ConfigurationSystem.md`
